<!-- static/player.html -->
<!doctype html>
<html lang="ru">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>JBOT Audio Player</title>
    <style>
        body { font-family: system-ui, sans-serif; max-width: 720px; margin: 24px auto; padding: 0 16px; }
        button { padding: 10px 14px; font-size: 14px; }
        code { background: #f3f3f3; padding: 2px 6px; border-radius: 6px; }
        .log { margin-top: 12px; white-space: pre-wrap; background: #111; color: #ddd; padding: 12px; border-radius: 8px; min-height: 140px; }
    </style>
</head>
<body>
<h1>JBOT Audio Player</h1>

<p>
    1) Нажми <b>Enable audio</b> один раз (иначе браузер блокирует автоплей).<br/>
    2) Держи вкладку открытой.
</p>

<button id="enable">Enable audio</button>
<div class="log" id="log"></div>

<script>
    const logEl = document.getElementById('log');
    const btn = document.getElementById('enable');

    const queue = [];
    let enabled = false;
    let playing = false;

    function log(msg) {
        const ts = new Date().toISOString().slice(11, 19);
        logEl.textContent += `[${ts}] ${msg}\n`;
        logEl.scrollTop = logEl.scrollHeight;
    }

    async function pump() {
        if (!enabled || playing) return;
        const url = queue.shift();
        if (!url) return;

        playing = true;
        try {
            log(`Playing: ${url}`);
            const audio = new Audio(url);
            audio.volume = 1.0;

            await new Promise((resolve, reject) => {
                audio.addEventListener('ended', resolve, { once: true });
                audio.addEventListener('error', () => reject(new Error('Audio error')), { once: true });
                audio.play().catch(reject);
            });

            log(`Ended: ${url}`);
        } catch (e) {
            log(`Failed: ${url} (${e?.message || e})`);
        } finally {
            playing = false;
            pump();
        }
    }

    btn.addEventListener('click', async () => {
        // “жест” пользователя — после этого play() обычно разрешён
        enabled = true;
        log('Audio enabled');
        pump();
    });

    // SSE: получаем команды play
    const es = new EventSource('/events');
    es.addEventListener('play', (ev) => {
        const data = JSON.parse(ev.data);
        queue.push(data.url);
        log(`Enqueued: ${data.url}`);
        pump();
    });
    es.addEventListener('open', () => log('Connected to /events'));
    es.addEventListener('error', () => log('SSE error (reconnecting...)'));
</script>
</body>
</html>